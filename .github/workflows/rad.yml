name: Build and Release Android aarch64 Libraries

on:
  push:
    tags:
      - 'v*'   # Trigger only on version tags like v1.0, v2.3, etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      API: 24
      TARGET: aarch64-linux-android
      PREFIX: ${{ github.workspace }}/android-libs

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Install prerequisites
    - name: Install dependencies
      run: sudo apt update && sudo apt install -y wget build-essential automake autoconf libtool pkg-config unzip

    # 3️⃣ Download NDK
    - name: Download Android NDK
      run: |
        mkdir -p ${{ github.workspace }}/android-ndk
        cd ${{ github.workspace }}/android-ndk
        wget https://dl.google.com/android/repository/android-ndk-r${{ env.ANDROID_NDK_VERSION }}-linux.zip
        unzip android-ndk-r${{ env.ANDROID_NDK_VERSION }}-linux.zip
        mv android-ndk-r${{ env.ANDROID_NDK_VERSION }}/* .
        rm -rf android-ndk-r${{ env.ANDROID_NDK_VERSION }}*

    # 4️⃣ Set environment
    - name: Setup environment
      run: |
        echo "ANDROID_NDK_HOME=${{ github.workspace }}/android-ndk" >> $GITHUB_ENV
        echo "TOOLCHAIN=${{ github.workspace }}/android-ndk/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
        echo "PATH=${{ github.workspace }}/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV
        echo "SYSROOT=${{ github.workspace }}/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV

    # 5️⃣ Build libraries
    - name: Build libraries
      run: |
        set -e
        mkdir -p $PREFIX
        export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
        export CXX=$TOOLCHAIN/bin/${TARGET}${API}-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export STRIP=$TOOLCHAIN/bin/llvm-strip
        export CFLAGS="--sysroot=$SYSROOT -I$PREFIX/include"
        export LDFLAGS="--sysroot=$SYSROOT -L$PREFIX/lib"

        build_library() {
          NAME=$1
          URL=$2
          CONFIGURE_FLAGS=$3
          echo "=== Building $NAME ==="
          wget -c $URL -O $NAME.tar.gz
          tar xf $NAME.tar.gz
          cd $NAME*
          ./configure --host=$TARGET --prefix=$PREFIX $CONFIGURE_FLAGS
          make -j$(nproc)
          make install
          cd ..
        }

        # Build each library
        build_library "libffi" "ftp://sourceware.org/pub/libffi/libffi-3.4.4.tar.gz" ""
        build_library "gdbm" "https://ftp.gnu.org/gnu/gdbm/gdbm-1.24.tar.gz" ""
        build_library "ncurses" "https://ftp.gnu.org/gnu/ncurses/ncurses-6.4.tar.gz" "--with-shared --without-debug --without-ada"
        build_library "readline" "https://ftp.gnu.org/gnu/readline/readline-8.2.tar.gz" ""
        build_library "tcl" "https://prdownloads.sourceforge.net/tcl/tcl8.6.13-src.tar.gz" ""
        build_library "tk" "https://prdownloads.sourceforge.net/tcl/tk8.6.13-src.tar.gz" "--with-tcl=$PREFIX/lib"
        build_library "ossp-uuid" "https://jaist.dl.osdn.jp/ossp-uuid/uuid-1.6.2.tar.gz" ""

    # 6️⃣ Zip the built libraries
    - name: Archive libraries
      run: |
        cd $PREFIX
        zip -r android-libs-${GITHUB_REF_NAME}.zip *

    # 7️⃣ Create a GitHub release and upload artifact
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: android-libs-${{ github.ref_name }}.zip
        asset_path: $PREFIX/android-libs-${GITHUB_REF_NAME}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
