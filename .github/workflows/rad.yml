name: Build and Release Android aarch64 Libraries (One ZIP per Module)

on:
  push:
    branches: [vrt, "3.*"]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: r27d
      API: 24
      TARGET: aarch64-linux-android
      PREFIX: ${{ github.workspace }}/android-libs

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Android NDK
        uses: actions/cache@v3
        id: cache-ndk
        with:
          path: ${{ github.workspace }}/android-ndk
          key: ndk-${{ env.ANDROID_NDK_VERSION }}-linux
          restore-keys: ndk-${{ env.ANDROID_NDK_VERSION }}-

      - name: Download Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          mkdir -p ${{ github.workspace }}/android-ndk
          cd ${{ github.workspace }}/android-ndk
          wget -q https://dl.google.com/android/repository/android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
          unzip -q android-ndk-${{ env.ANDROID_NDK_VERSION }}-linux.zip
          mv android-ndk-${{ env.ANDROID_NDK_VERSION }}/* .
          rm -rf android-ndk-${{ env.ANDROID_NDK_VERSION }}*

      - name: Setup environment
        run: |
          TOOLCHAIN="${{ github.workspace }}/android-ndk/toolchains/llvm/prebuilt/linux-x86_64"
          SYSROOT="$TOOLCHAIN/sysroot"

          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          echo "SYSROOT=$SYSROOT" >> $GITHUB_ENV
          echo "$TOOLCHAIN/bin" >> $GITHUB_PATH

          TARGET_TRIPLE="${{ env.TARGET }}${{ env.API }}"
          echo "TARGET_TRIPLE=$TARGET_TRIPLE" >> $GITHUB_ENV

          COMMON_FLAGS=" "
          echo "COMMON_FLAGS=$COMMON_FLAGS" >> $GITHUB_ENV

          echo "CC=$TOOLCHAIN/bin/aarch64-linux-android24-clang $COMMON_FLAGS" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN/bin/aarch64-linux-android24-clang++ $COMMON_FLAGS" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/bin/llvm-ar" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/bin/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/bin/llvm-strip" >> $GITHUB_ENV

      - name: Install host dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            wget tar gzip bzip2 build-essential \
            autoconf automake libtool pkg-config \
            unzip zip curl patch

      - name: Build and package modules
        id: build
        run: |
          set -eux
          mkdir -p "$PREFIX"

          # === CRITICAL: Pass full flags to configure ===
          COMMON_CFLAGS="$COMMON_FLAGS -O2 -fPIC"
          COMMON_LDFLAGS="$COMMON_FLAGS -L$SYSROOT/usr/lib/$TARGET_TRIPLE/$API"

          build_and_zip() {
            local name="$1"
            local url="$2"
            local cfg_extra="$3"
            local need_autoreconf="${4:-false}"
            local post_cfg="${5:-}"

            local module_dir="$PREFIX/$name"
            mkdir -p "$module_dir"

            echo "=== Building $name ==="
            wget -q "$url" -O "$name.tar.gz"
            tar xf "$name.tar.gz"

            local srcdir
            srcdir=$(find . -maxdepth 1 -type d -name "${name}*" ! -name "." | head -n1)
            [ -z "$srcdir" ] && { echo "ERROR: No source dir for $name"; exit 1; }
            echo "Source: $srcdir"
            cd "$srcdir"

            $need_autoreconf && autoreconf -fi

            eval "$post_cfg" || true

            # === PASS CFLAGS and LDFLAGS explicitly ===
            CFLAGS=" -I$module_dir/include" \
            LDFLAGS=" -L$module_dir/lib" \
            ./configure \
              --host="$TARGET_TRIPLE" \
              --prefix="$module_dir" \
              $cfg_extra

            make -j$(nproc)
            make install-strip

            cd ..
            zip -r9 "${name}-${{ github.ref_name }}.zip" "$name"
            echo "${name}_zip=$(pwd)/${name}-${{ github.ref_name }}.zip" >> $GITHUB_OUTPUT

            rm -rf "$srcdir" "$name.tar.gz"
          }

          # === Build modules ===
          build_and_zip gdbm \
            "https://ftp.gnu.org/gnu/gdbm/gdbm-1.26.tar.gz" \
            ""

          build_and_zip ncurses \
            "https://ftp.gnu.org/gnu/ncurses/ncurses-6.5.tar.gz" \
            "--with-shared --without-debug --without-ada \
             --without-manpages --without-progs --without-tests \
             --enable-widec --enable-pc-files"

          build_and_zip readline \
            "https://ftp.gnu.org/gnu/readline/readline-8.3.tar.gz" \
            "--with-curses"

          build_and_zip uuid \
            "http://www.ossp.org/pkg/lib/uuid/uuid-1.6.2.tar.gz" \
            "--disable-shared" true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Android aarch64 Modules ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            ${{ steps.build.outputs.gdbm_zip }}
            ${{ steps.build.outputs.ncurses_zip }}
            ${{ steps.build.outputs.readline_zip }}
            ${{ steps.build.outputs.uuid_zip }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
