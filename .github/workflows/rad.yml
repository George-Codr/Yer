name: Build and Release Android aarch64 Libraries

on:
  push:
    branches: [vrt, "3.*"]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      ANDROID_NDK_VERSION: 27.3.13750724
      API: 24
      TARGET: aarch64-linux-android
      PREFIX: ${{ github.workspace }}/android-libs

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Install prerequisites
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y wget build-essential automake autoconf libtool pkg-config unzip zip

    # 3️⃣ Download Android NDK
    - name: Download Android NDK
      run: |
        mkdir -p ${{ github.workspace }}/android-ndk
        cd ${{ github.workspace }}/android-ndk
        wget https://dl.google.com/android/repository/android-ndk-r27d-linux.zip
        unzip -q android-ndk-r27d-linux.zip
        mv android-ndk-r27d/* .
        rm -rf android-ndk-r27d*

    # 4️⃣ Setup environment
    - name: Setup environment
      run: |
        echo "ANDROID_NDK_HOME=${{ github.workspace }}/android-ndk" >> $GITHUB_ENV
        echo "TOOLCHAIN=${{ github.workspace }}/android-ndk/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
        echo "PATH=${{ github.workspace }}/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV
        echo "SYSROOT=${{ github.workspace }}/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot" >> $GITHUB_ENV

    # 5️⃣ Build libraries
    - name: Build libraries
      run: |
        set -e
        mkdir -p $PREFIX
        export CC=$TOOLCHAIN/bin/${TARGET}${API}-clang
        export CXX=$TOOLCHAIN/bin/${TARGET}${API}-clang++
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        export STRIP=$TOOLCHAIN/bin/llvm-strip
        export CFLAGS="--sysroot=$SYSROOT -I$PREFIX/include"
        export LDFLAGS="--sysroot=$SYSROOT -L$PREFIX/lib"

        build_library() {
          NAME=$1
          URL=$2
          CONFIGURE_FLAGS=$3
          echo "=== Building $NAME ==="
          wget -c "$URL" -O ${NAME}.tar.gz
          tar xf ${NAME}.tar.gz
          DIR=$(find . -maxdepth 1 -type d -name "${NAME}*" | head -n 1)
          cd "$DIR"
          ./configure --host=$TARGET --prefix=$PREFIX $CONFIGURE_FLAGS || (echo "Configure failed for $NAME" && exit 1)
          make -j$(nproc)
          make install
          cd ..
        }

        build_library "libffi" "https://github.com/libffi/libffi/archive/refs/tags/v3.4.4.tar.gz" ""
        build_library "gdbm" "https://ftp.gnu.org/gnu/gdbm/gdbm-1.26.tar.gz" ""
        build_library "ncurses" "https://ftp.gnu.org/gnu/ncurses/ncurses-6.5.tar.gz" "--with-shared --without-debug --without-ada"
        build_library "readline" "https://ftp.gnu.org/gnu/readline/readline-8.3.tar.gz" ""
        build_library "tcl" "https://downloads.sourceforge.net/tcl/tcl8.6.14-src.tar.gz" ""
        build_library "tk" "https://downloads.sourceforge.net/tcl/tk8.6.14-src.tar.gz" "--with-tcl=$PREFIX/lib"
        build_library "ossp-uuid" "ftp://ftp.ossp.org/pkg/lib/uuid/uuid-1.6.2.tar.gz" ""

    # 6️⃣ Zip the built libraries
    - name: Archive libraries
      run: |
        cd $PREFIX
        zip -r android-libs-${GITHUB_REF_NAME}.zip *

    # 7️⃣ Create GitHub release and upload
    - name: Create and upload release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.PREFIX }}/android-libs-${{ github.ref_name }}.zip
        tag_name: ${{ github.ref_name }}
        name: Android aarch64 Libraries ${{ github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
