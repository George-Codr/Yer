name: Build Android

on:
  workflow_dispatch:
  push:
    branches: [main, '3.*']
  pull_request:
    branches: [main, '3.*']

permissions:
  contents: read

jobs:
  build-android:
    if: >-
      ${{ github.repository_owner == 'George-Codr' &&
          github.event.repository.name == 'Yer' }}

    name: Python ${{ matrix.version }} to aarch64-linux-android (NDK clang only)
    runs-on: macos-14
    timeout-minutes: 180

    strategy:
      fail-fast: false
      matrix:
        include:
          - version: 3.13.9
            filename: Python-3.13.9.tgz
            folder: Python-3.13.9
            url_secret: PY313_URL
            ndk_version: 27.3.13750724
          - version: 3.14.0
            filename: Python-3.14.0.tgz
            folder: Python-3.14.0
            url_secret: PY314_URL
            ndk_version: 27.3.13750724
          - version: 3.15.0a1
            filename: Python-3.15.0a1.tgz
            folder: Python-3.15.0a1
            url_secret: PY315_URL
            ndk_version: 27.3.13750724

    env:
      ARCH: aarch64
      ANDROID_NDK_VERSION: ${{ matrix.ndk_version }}
      DEPS_ROOT: yrtuo
      NDK_ROOT: ${{ github.workspace }}/android-ndk-r${{ matrix.ndk_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install minimal tools
        run: |
          brew install wget dpkg bash zstd curl
          brew uninstall gcc || true

      - name: Install Android NDK
        run: |
          set -euxo pipefail
          sdkmanager "ndk;${{ env.ANDROID_NDK_VERSION }}"
          echo "NDK_HOME=$ANDROID_HOME/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
          ln -s "$ANDROID_HOME/ndk/${{ env.ANDROID_NDK_VERSION }}" "${{ env.NDK_ROOT }}"

      - name: Extract Termux deps
        run: |
          set -euxo pipefail
          DEPS_ROOT="${{ env.DEPS_ROOT }}"
          mkdir -p "$DEPS_ROOT"/{lib,include,bin,share}

          DEBS=(
            "https://packages.termux.dev/apt/termux-main/pool/main/x/xz-utils/xz-utils_5.8.1-1_aarch64.deb"
            "https://packages.termux.dev/apt/termux-main/pool/main/t/tcl/tcl_8.6.14-1_aarch64.deb"
            "https://packages.termux.dev/apt/termux-main/pool/main/t/tk/tk_8.6.14-1_aarch64.deb"
            "https://packages.termux.dev/apt/termux-main/pool/main/libf/libffi/libffi_3.4.7-1_aarch64.deb"
            "https://packages.termux.dev/apt/termux-main/pool/main/n/ncurses/ncurses_6.5.20240831-3_aarch64.deb"
            "https://packages.termux.dev/apt/termux-main/pool/main/g/gdbm/gdbm_1.26-1_aarch64.deb"
            "https://packages.termux.dev/apt/termux-main/pool/main/libu/libuuid/libuuid_2.41.2_aarch64.deb"
            "https://packages.termux.dev/apt/termux-main/pool/main/r/readline/readline_8.3.1-2_aarch64.deb"
          )

          TMP=$(mktemp -d)
          trap 'rm -rf "$TMP"' EXIT

          for url in "${DEBS[@]}"; do
            deb=$(basename "$url")
            curl -fsSL "$url" -o "$TMP/$deb"
            dpkg-deb -x "$TMP/$deb" "$TMP"
            root="$TMP/data/data/com.termux/files"
            [ -d "$root" ] || continue
            for d in lib include bin share; do
              src="$root/usr/$d"
              [ -d "$src" ] && cp -a "$src/"* "$DEPS_ROOT/$d/" 2>/dev/null || true
            done
            rm -f "$TMP/$deb"
            rm -rf "$TMP/data"
          done

          echo "$DEPS_ROOT/bin" >> $GITHUB_PATH

      - name: Download CPython source
        run: |
          set -euxo pipefail
          FILE="${{ matrix.filename }}"
          FOLDER="${{ matrix.folder }}"
          VERSION="${{ matrix.version }}"

          case "$VERSION" in
            3.13.9)  URL="${{ secrets.PY313_URL }}" ;;
            3.14.0)  URL="${{ secrets.PY314_URL }}" ;;
            3.15.0a1)URL="${{ secrets.PY315_URL }}" ;;
            *) echo "Unknown version"; exit 1 ;;
          esac

          [ -z "$URL" ] && { echo "Missing secret"; exit 1; }
          curl -fsSL "$URL" -o "$FILE"
          tar -xzf "$FILE"
          mv "$FOLDER" "cpython-${VERSION}"

      - name: Build with NDK clang only
        working-directory: ./cpython-${{ matrix.version }}
        env:
          DEPS_ROOT: ${{ github.workspace }}/${{ env.DEPS_ROOT }}
          NDK_CLANG: ${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android21-clang
          NDK_CLANGXX: ${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android21-clang++
          NDK_AR: ${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/llvm-ar
          NDK_RANLIB: ${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/llvm-ranlib
          HOST_CC: ${{ env.NDK_CLANG }}
          HOST_CXX: ${{ env.NDK_CLANGXX }}
          HOST_AR: ${{ env.NDK_AR }}
          HOST_RANLIB: ${{ env.NDK_RANLIB }}
          CPPFLAGS: -I${{ github.workspace }}/${{ env.DEPS_ROOT }}/include
          LDFLAGS: -L${{ github.workspace }}/${{ env.DEPS_ROOT }}/lib -Wl,-rpath-link,${{ github.workspace }}/${{ env.DEPS_ROOT }}/lib
        run: |
          set -euxo pipefail
          "$NDK_CLANG" --version
          "$NDK_CLANGXX" --version
          curl -fsSL https://raw.githubusercontent.com/George-Codr/Yer/refs/heads/main/android-env.sh -o android-env.sh
          chmod +x android-env.sh
          case "${{ matrix.version }}" in
            3.13.9)
              curl -fsSL https://raw.githubusercontent.com/yubrajbhoi/termux-python/fb5bad6582a83fe6db36840f47e29521083160a1/termux.patch -o termux.patch
              git apply termux.patch
              ;;
            3.14.0)
              curl -fsSL https://raw.githubusercontent.com/yubrajbhoi/termux-python/refs/heads/main/termux.patch -o termux.patch
              git apply termux.patch
              ;;
          esac
          cd Android
          python3 ./android.py clean || true
          python3 ./android.py ci aarch64-linux-android
          ls -lh ../cross-build/aarch64-linux-android/ || true
          du -sh ../cross-build/aarch64-linux-android/

      - name: Upload Android Python build
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ matrix.version }}-aarch64-android
          path: cpython-${{ matrix.version }}/cross-build/aarch64-linux-android/
