name: Build Android

on:
  workflow_dispatch:
  push:
    branches: [main, '3.*']
  pull_request:
    branches: [main, '3.*']

jobs:
  build-template:
    if: ${{ github.repository_owner == 'George-Codr' && github.event.repository.name == 'Yer' }}
    name: Build Android Python (${{ matrix.version }}) NDK ${{ matrix.ndk_major }}
    runs-on: macos-14
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: 3.13.9
            filename: Python-3.13.9.tgz
            folder: Python-3.13.9
            url_secret: PY313_URL
            ndk_version: 29.0.14206865
            ndk_major: 29
          - version: 3.14.0
            filename: Python-3.14.0.tgz
            folder: Python-3.14.0
            url_secret: PY314_URL
            ndk_version: 29.0.14206865
            ndk_major: 29
          - version: 3.15.0a1
            filename: Python-3.15.0a1.tgz
            folder: Python-3.15.0a1
            url_secret: PY315_URL
            ndk_version: 29.0.14206865
            ndk_major: 29

    env:
      ARCH: aarch64
      ANDROID_NDK_VERSION: ${{ matrix.ndk_version }}
      LLVM_VERSION: 21
      DEPS_ROOT: yrtuo

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Install minimal macOS tools
        run: |
          brew install wget dpkg gh
          brew uninstall gcc || true
          echo "Minimal macOS tools installed."
      - name: Download prebuilts
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p yrtuo/include yrtuo/lib
          export DEPS_ROOT="${{ github.workspace }}/yrtuo"

          declare -A DEPS
          DEPS[tcl-core]="https://github.com/python/cpython-source-deps/releases/download/tcl-core-8.6.15.0/tcl-core-8.6.15.0.tar.gz"
          DEPS[tk]="https://github.com/python/cpython-source-deps/releases/download/tk-8.6.15.0/tk-8.6.15.0.tar.gz"
          DEPS[libffi]="https://github.com/python/cpython-source-deps/archive/refs/tags/libffi-3.4.7.zip"
          DEPS[xz]="https://github.com/python/cpython-source-deps/archive/refs/tags/xz-5.8.1.1.zip"

          for name in "${!DEPS[@]}"; do
            url="${DEPS[$name]}"
            file="$(basename "$url")"
            curl -L "$url" -o "$file"

            case "$file" in
              *.tar.gz) tar -xzf "$file" -C "$DEPS_ROOT" ;;
              *.zip)    unzip -q "$file" -d "$DEPS_ROOT" ;;
            esac
            rm -f "$file"
          done

          # Move extracted files
          mv "$DEPS_ROOT"/tcl-core-*/include/* "$DEPS_ROOT/include/" 2>/dev/null || true
          mv "$DEPS_ROOT"/tcl-core-*/lib/*     "$DEPS_ROOT/lib/"     2>/dev/null || true
          mv "$DEPS_ROOT"/tk-*/include/*       "$DEPS_ROOT/include/" 2>/dev/null || true
          mv "$DEPS_ROOT"/tk-*/lib/*           "$DEPS_ROOT/lib/"     2>/dev/null || true
          mv "$DEPS_ROOT"/libffi-*/include/*   "$DEPS_ROOT/include/" 2>/dev/null || true
          mv "$DEPS_ROOT"/libffi-*/lib/*       "$DEPS_ROOT/lib/"     2>/dev/null || true
          mv "$DEPS_ROOT"/xz-*/include/*       "$DEPS_ROOT/include/" 2>/dev/null || true
          mv "$DEPS_ROOT"/xz-*/lib/*           "$DEPS_ROOT/lib/"     2>/dev/null || true

          # Serom prebuilts
          declare -A SEROM
          SEROM[readline]="https://github.com/aikwp/Serom/releases/download/vrt/readline-vrt.zip"
          SEROM[ncurses]="https://github.com/aikwp/Serom/releases/download/vrt/ncurses-vrt.zip"
          SEROM[gdbm]="https://github.com/aikwp/Serom/releases/download/vrt/gdbm-vrt.zip"

          for name in "${!SEROM[@]}"; do
            url="${SEROM[$name]}"
            file="$(basename "$url")"
            curl -L "$url" -o "$file"
            unzip -q "$file" -d "$DEPS_ROOT"
            rm -f "$file"
            mv "$DEPS_ROOT/$name/include"/* "$DEPS_ROOT/include/" 2>/dev/null || true
            mv "$DEPS_ROOT/$name/lib"/*     "$DEPS_ROOT/lib/"     2>/dev/null || true
            rm -rf "$DEPS_ROOT/$name"
          done

          echo "$DEPS_ROOT/bin" >> $GITHUB_PATH
          echo "yrtuo deps ready in $DEPS_ROOT"
      - name: Set up Android SDK + NDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          set -euxo pipefail
          sdkmanager "ndk;${ANDROID_NDK_VERSION}"
          echo "Android NDK ${ANDROID_NDK_VERSION} installed."
          ls -1 $ANDROID_HOME/ndk/
      - name: Set environment to use SDK/NDK Clang
        run: |
          set -euxo pipefail

          export NDK_PATH="$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}"
          if [ -d "$NDK_PATH/toolchains/llvm/prebuilt/darwin-x86_64" ]; then
            export TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/darwin-x86_64"
          elif [ -d "$NDK_PATH/toolchains/llvm/prebuilt/darwin-arm64" ]; then
            export TOOLCHAIN="$NDK_PATH/toolchains/llvm/prebuilt/darwin-arm64"
          else
            echo "NDK toolchain not found"
            exit 1
          fi
          echo "$TOOLCHAIN/bin" >> $GITHUB_PATH

          export CC="$TOOLCHAIN/bin/clang"
          export CXX="$TOOLCHAIN/bin/clang++"
          export AR="$TOOLCHAIN/bin/llvm-ar"
          export LD="$TOOLCHAIN/bin/ld.lld"
          export NM="$TOOLCHAIN/bin/llvm-nm"
          export RANLIB="$TOOLCHAIN/bin/llvm-ranlib"

          echo "Using Clang from $TOOLCHAIN"
          $CC --version
          export CPPFLAGS="-I$DEPS_ROOT/include $CPPFLAGS"
          export LDFLAGS="-L$DEPS_ROOT/lib $LDFLAGS"
          export PKG_CONFIG_PATH="$DEPS_ROOT/lib/pkgconfig:$PKG_CONFIG_PATH"
          export PATH="$DEPS_ROOT/bin:$PATH"
          export CPU_COUNT="$(sysctl -n hw.ncpu)"
          echo "Host environment configured."
      - name: Download official Python source tarball (from Secret)
        run: |
          set -euxo pipefail
          FILE="${{ matrix.filename }}"
          FOLDER="${{ matrix.folder }}"
          VERSION="${{ matrix.version }}"

          case "$VERSION" in
            3.13.9) URL="${{ secrets.PY313_URL }}" ;;
            3.14.0) URL="${{ secrets.PY314_URL }}" ;;
            3.15.0a1) URL="${{ secrets.PY315_URL }}" ;;
            *) echo "Unknown version $VERSION"; exit 1 ;;
          esac

          [ -z "$URL" ] && { echo "Secret for $VERSION missing"; exit 1; }

          curl -L "$URL" -o "$FILE"
          tar -xzf "$FILE"
          mv "$FOLDER" "cpython-${VERSION}"
      - name: Build CPython for Android
        working-directory: ./cpython-${{ matrix.version }}/Android
        env:
          CC: ${{ env.CC }}
          CXX: ${{ env.CXX }}
          AR: ${{ env.AR }}
          LD: ${{ env.LD }}
          NM: ${{ env.NM }}
          RANLIB: ${{ env.RANLIB }}
        run: |
          set -euxo pipefail
          cd ..
          VERSION="${{ matrix.version }}"
          case "$VERSION" in
            3.13.9) wget https://raw.githubusercontent.com/yubrajbhoi/termux-python/fb5bad6582a83fe6db36840f47e29521083160a1/termux.patch && git apply termux.patch ;;
            3.14.0) wget https://raw.githubusercontent.com/yubrajbhoi/termux-python/refs/heads/main/termux.patch && git apply termux.patch ;;
            *) echo "Skip patch" ;;
          esac
          cd Android
          rm -rf android-env.sh 
          wget https://raw.githubusercontent.com/George-Codr/Yer/refs/heads/main/android-env.sh
          ./android.py clean
          ./android.py ci --fast-ci aarch64-linux-android
          echo "Build finished for version ${{ matrix.version }}"
          ls -lh ../cross-build/aarch64-linux-android || true

