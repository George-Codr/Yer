name: Build Python on Windows x64 and Create Release

on:
  push:
    branches:
      - windows
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        version:
          - "3.13.11"
          - "3.14.2"
          - "3.15.0a5"
        include:
          - version: "3.13.11"
            filename: "Python-3.13.11.tgz"
            folder: "Python-3.13.11"
            prerelease: false
          - version: "3.14.2"
            filename: "Python-3.14.2.tgz"
            folder: "Python-3.14.2"
            prerelease: false
          - version: "3.15.0a5"
            filename: "Python-3.15.0a5.tgz"
            folder: "Python-3.15.0a5"
            prerelease: true

    name: Build Python ${{ matrix.version }} (Windows x64)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4   # v6 not released yet in most runners

      - name: Download Python ${{ matrix.version }} source
        shell: pwsh
        run: |
          $url = "https://www.python.org/ftp/python/${{ matrix.version }}/${{ matrix.filename }}"
          Write-Host "Downloading from $url"
          Invoke-WebRequest -Uri $url -OutFile "${{ matrix.filename }}"

      - name: Extract source archive
        shell: pwsh
        run: |
          tar -xzf "${{ matrix.filename }}"

      - name: Set up MSVC developer command prompt (x64)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build Python ${{ matrix.version }} (x64 Release)
        shell: cmd
        run: |
          cd ${{ matrix.folder }}\PCbuild
          build.bat -p x64 -c Release
          if errorlevel 1 exit /b 1

      - name: Verify Python version
        shell: cmd
        run: |
          cd ${{ matrix.folder }}\PCbuild\amd64
          .\python.exe --version

      - name: Prepare portable distribution directory
        shell: pwsh
        run: |
          $pkgDir = "python-${{ matrix.version }}-windows-x64-portable"
          New-Item -ItemType Directory -Path $pkgDir -Force

          Copy-Item -Path "${{ matrix.folder }}/PCbuild/amd64/python.exe"          -Destination $pkgDir/
          Copy-Item -Path "${{ matrix.folder }}/PCbuild/amd64/*.dll"               -Destination $pkgDir/
          Copy-Item -Path "${{ matrix.folder }}/PCbuild/amd64/*.pyd"               -Destination $pkgDir/ -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "${{ matrix.folder }}/Lib"                               -Destination $pkgDir/Lib -Recurse
          Copy-Item -Path "${{ matrix.folder }}/Include"                           -Destination $pkgDir/Include -Recurse

          # Optional: add Scripts/ if you want pip etc. pre-installed later
          # New-Item -ItemType Directory -Path "$pkgDir\Scripts" -Force

          # Simple README
          @"
          Portable Python ${{ matrix.version }} for Windows x64
          Built from official source on GitHub Actions (windows-latest)
          Date: $(Get-Date -Format "yyyy-MM-dd")
          Commit: ${{ github.sha }}

          Usage:
            - Extract and run python.exe
            - Optionally run: python -m ensurepip --upgrade
          "@ | Out-File -FilePath "$pkgDir\README.txt" -Encoding utf8

      - name: Create zip archive
        shell: pwsh
        run: |
          $zipName = "python-${{ matrix.version }}-windows-x64-portable.zip"
          Compress-Archive -Path "python-${{ matrix.version }}-windows-x64-portable\*" -DestinationPath $zipName -Force

      - name: Create/Update GitHub Release & upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: __win
          name: Python 3.13,3.14,3.15 Windows x64 Portable
          body: |
            Automatic build of Python 3.13, 3.14, 3.15 from official source tarball on Windows x64 (Release mode).

            - Runner: windows-latest
            - Commit: ${{ github.sha }}
            - Date: ${{ github.event.repository.updated_at || github.event.head_commit.timestamp }}

            Portable â†’ extract and use `python.exe` directly.
            Pre-release versions may be unstable.
          prerelease: ${{ matrix.prerelease }}
          generate_release_notes: false   # or true if you want auto-changelog (usually noisy for source builds)
          files: python-${{ matrix.version }}-windows-x64-portable.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
